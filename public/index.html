<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务健康与测试仪表盘</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 900px; margin: 20px auto; padding: 0 20px; background-color: #f8f9fa; }
        h1, h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input, .input-group textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #218838; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #log-container { background-color: #222; color: #eee; padding: 15px; border-radius: 5px; height: 300px; overflow-y: scroll; font-family: 'Courier New', Courier, monospace; font-size: 14px; }
        .log-entry { padding: 2px 0; border-bottom: 1px solid #444; }
        .log-entry.error { color: #ff8a8a; }
        .log-entry.success { color: #8aff8a; }
        .log-entry.info { color: #8acfff; }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .status-item { background: #e9ecef; padding: 15px; border-radius: 5px; }
        .status-item h3 { margin-top: 0; }
    </style>
</head>
<body>

    <h1>服务健康与测试仪表盘</h1>

    <div class="container">
        <h2>1. 配置</h2>
        <div class="input-group">
            <label for="api-host">API 地址 (Host)</label>
            <input type="text" id="api-host" value="https://adorable-lily-951a2e.netlify.app">
        </div>
        <div class="input-group">
            <label for="api-key">自定义访问密钥</label>
            <input type="password" id="api-key" value="67564534">
        </div>
    </div>

    <div class="container">
        <h2>2. 服务状态诊断</h2>
        <button id="run-diag-btn">检查服务状态</button>
        <div class="status-grid" id="diag-results" style="margin-top: 15px;"></div>
    </div>

    <div class="container">
        <h2>3. 模型列表</h2>
        <button id="load-models-btn">加载模型列表</button>
        <div class="input-group" style="margin-top: 15px;">
            <label for="models-select">可用模型</label>
            <select id="models-select" style="width: 100%; padding: 10px;"></select>
        </div>
    </div>

    <div class="container">
        <h2>4. 聊天测试</h2>
        <div class="input-group">
            <label for="chat-input">输入消息</label>
            <textarea id="chat-input" rows="3">你好，请介绍一下你自己。</textarea>
        </div>
        <button id="send-chat-btn">发送</button>
    </div>
    
    <div class="container">
        <h2>5. 实时日志与结果</h2>
        <div id="log-container"></div>
    </div>

    <script>
        const getEl = (id) => document.getElementById(id);

        const apiHostInput = getEl('api-host');
        const apiKeyInput = getEl('api-key');
        const runDiagBtn = getEl('run-diag-btn');
        const diagResults = getEl('diag-results');
        const loadModelsBtn = getEl('load-models-btn');
        const modelsSelect = getEl('models-select');
        const chatInput = getEl('chat-input');
        const sendChatBtn = getEl('send-chat-btn');
        const logContainer = getEl('log-container');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] [${type.toUpperCase()}] ${message}`;
            logContainer.prepend(entry);
        }

        async function fetchAPI(endpoint, options = {}) {
            const host = apiHostInput.value.trim();
            const key = apiKeyInput.value.trim();
            if (!host || !key) {
                log('API 地址和密钥不能为空', 'error');
                return null;
            }

            const url = `${host}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${key}`,
                ...options.headers,
            };

            log(`请求 -> ${url}`, 'info');
            if (options.body) {
                log(`请求体: ${options.body}`, 'info');
            }

            try {
                const response = await fetch(url, { ...options, headers });
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`请求失败: ${response.status} ${response.statusText} - ${errorText}`, 'error');
                    return null;
                }
                const data = await response.json();
                log(`响应 <- ${JSON.stringify(data)}`, 'success');
                return data;
            } catch (error) {
                log(`网络错误: ${error.message}`, 'error');
                return null;
            }
        }

        runDiagBtn.addEventListener('click', async () => {
            diagResults.innerHTML = '';
            log('开始服务状态诊断...');
            const data = await fetchAPI('/v1/diag/status');
            if (data) {
                diagResults.innerHTML = `
                    <div class="status-item">
                        <h3>密钥池状态</h3>
                        <p>${data.keys_loaded > 0 ? '✅ 初始化成功' : '❌ 初始化失败'}</p>
                    </div>
                    <div class="status-item">
                        <h3>内置密钥总数</h3>
                        <p>${data.keys_loaded} 个</p>
                    </div>
                    <div class="status-item">
                        <h3>冷却中的密钥</h3>
                        <p>${data.keys_in_cooldown} 个</p>
                    </div>
                `;
            }
        });

        loadModelsBtn.addEventListener('click', async () => {
            modelsSelect.innerHTML = '';
            log('开始加载模型列表...');
            const data = await fetchAPI('/v1/models');
            if (data && data.data) {
                data.data.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    modelsSelect.appendChild(option);
                });
                log(`成功加载 ${data.data.length} 个模型。`, 'success');
            }
        });

        sendChatBtn.addEventListener('click', async () => {
            const message = chatInput.value.trim();
            const selectedModel = modelsSelect.value;
            if (!message) {
                log('聊天内容不能为空', 'error');
                return;
            }
            if (!selectedModel) {
                log('请先加载并选择一个模型', 'error');
                return;
            }

            log('开始发送聊天请求...');
            const body = {
                model: selectedModel,
                messages: [{ role: 'user', content: message }],
                stream: false, // 为简化，本工具仅支持非流式
            };
            await fetchAPI('/v1/chat/completions', {
                method: 'POST',
                body: JSON.stringify(body),
            });
        });

        // Auto-run diagnostics on page load
        runDiagBtn.click();

    </script>
</body>
</html>
